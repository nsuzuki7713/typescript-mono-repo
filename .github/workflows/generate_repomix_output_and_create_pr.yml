name: Generate Repomix Output and Create PR

on:
  workflow_dispatch:
  schedule:
    - cron: "45 0 * * 1-5" # 日本時間平日毎日09:45 (UTC 00:45)

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: "22.x"
  PNPM_VERSION: "10.10.0"

jobs:
  generate_and_create_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Install repomix globally with pnpm
        run: pnpm add -g repomix

      - name: Run repomix to generate output
        run: |
          repomix --output repomix-output.xml

          # repomix-output.xml が生成されたか確認
          if [ ! -f "repomix-output.xml" ]; then
            echo "❌ repomix-output.xml was not generated by the 'repomix' command."
            echo "Please ensure 'repomix' is installed correctly and the command generates 'repomix-output.xml' in the repository root."
            exit 1
          fi
          echo "✅ repomix-output.xml generated successfully."

      - name: Check for changes
        id: check_changes
        run: |
          # untrackedファイルがある場合も変更ありとして扱う
          if git status --porcelain repomix-output.xml | grep -q .; then
            echo "Changes detected in repomix-output.xml"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected in repomix-output.xml"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          echo "current_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Create Pull Request if changes found in repomix-output.xml
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Update repomix-output.xml"
          title: "Automated PR: Update repomix-output.xml"
          body: |
            ## 📄 Automated repomix-output.xml Update

            This Pull Request was automatically generated by GitHub Actions.
            ### 🔄 Changes
            - Date: ${{ steps.check_changes.outputs.current_date }}

            ### 📅 Generated on
            - Date: ${{ steps.check_changes.outputs.current_date }}
            - Workflow run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### ✅ Next Steps
            Please review the changes and merge if appropriate.
          branch: "feature/auto-update-repomix-output"
          base: "main"
          add-paths: |
            repomix-output.xml
          reviewers: |
            nsuzuki7713
